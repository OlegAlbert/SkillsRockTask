# Wallet Service API

## Описание

Wallet Service — это REST API для управления балансом кошельков.
Приложение предоставляет возможность получения баланса и обновления баланса кошелька с использованием операций пополнения (`DEPOSIT`) и снятия (`WITHDRAW`).

---

## Функциональность

1. **Изменение баланса кошелька:**
   - Метод `POST /api/v1/wallet` позволяет обновить баланс кошелька, выполняя операции пополнения (`DEPOSIT`) или снятия (`WITHDRAW`).

2. **Получение текущего баланса кошелька:**
   - Метод `GET /api/v1/wallets/{WALLET_UUID}` возвращает текущий баланс кошелька.

3. **Обработка ошибок:**
   Система обрабатывает следующие ошибки:
   - Неверный формат JSON.
   - Ошибки валидации входных данных.
   - Кошелек не существует.
   - Недостаточно средств для выполнения операции.

4. **Работа в конкурентной среде:**
   Сервис поддерживает нагрузку до 1000 запросов в секунду на один кошелек.

---

## Технологии

- **Java 17**
- **Spring Boot**
- **Hibernate (JPA)**
- **PostgreSQL**
- **Docker & Docker Compose**
- **Lombok**
- **JUnit 5** / **Mockito** + **H2DB** для тестирования

---

## Как запустить проект

### Шаги для запуска:

1. **Склонируйте репозиторий:**
   ```
   git clone https://github.com/OlegAlbert/SkillsRockTask.git
   cd SkillsRockTask
2. **Запустите Docker Compose:**
   ```
   docker-compose up --build
3. **Приложение будет доступно по адресу:**
   API: http://localhost:8080

4. **Тестовые данные для приложения:**
   В приложение добавлены тестовые данные, чтобы можно было сразу протестировать функционал с помощью Postman или других инструментов:
   ```
   Walet {
     walletId: 5ae7a7bb-009d-485d-aedd-b37e98e941de
     balance: 1000
   }
   ```
   ```
   Transaction {
     id: 5fb5e129-7b5d-4526-33e3-b93bc23963e5
     wallet_id: 5ae7a7bb-009d-485d-aedd-b37e98e941de
     operation_type: DEPOSIT
     amount: 1500.00
     date_of_operation: 2025-01-10 00:00:00.000000
   }
   ```
   ```
   Transaction {
     id: 7896cccc-46fc-4cb8-a86b-1fbaa24c01ec
     wallet_id: 5ae7a7bb-009d-485d-aedd-b37e98e941de
     operation_type: WITHDRAW
     amount: 500.00
     date_of_operation: 2025-01-11 00:00:00.000000
   }
   ```

---

## Конфигурация
Все параметры приложения, такие как URL базы данных и настройки подключения, могут быть настроены через переменные окружения или в файле **application.yaml**

---

## Примеры запросов:
1. **Получить баланс кошелька**
   - Возвращает текущий баланс кошелька.

**HTTP-запрос:**
   ```
   GET /api/v1/wallets/{wallet_uuid} HTTP/1.1
   Host: localhost:8080
   Content-Type: application/json
   ```
**Пример ответа:**
```
{
  "walletId": "5ae7a7bb-009d-485d-aedd-b37e98e941da",
  "balance": 150.00
}
```
2. **Обновить баланс кошелька**
   - Выполняет операцию пополнения или снятия средств.

**HTTP-запрос:**
```
POST /api/v1/wallet HTTP/1.1
Host: localhost:8080
Content-Type: application/json

{
  "walletId": "5ae7a7bb-009d-485d-aedd-b37e98e941da",
  "operationType": "DEPOSIT",
  "amount": 100.00
}
```
**Пример ответа:**
```
{
  "walletId": "5ae7a7bb-009d-485d-aedd-b37e98e941da",
  "balance": 250.00
}
```
3. **Обработка ошибок:**
   - При неверном запросе или формате JSON отправляет информативное сообщение об ошибке.

**Пример ошибки при недостаточном балансе:**
```
POST /api/v1/wallet HTTP/1.1
Host: localhost:8080
Content-Type: application/json

{
  "walletId": "5ae7a7bb-009d-485d-aedd-b37e98e941da",
  "operationType": "WITHDRAW",
  "amount": 1000.00
}
```
**Ответ:**
```
{
  "timestamp": "2025-01-14T17:50:56.064547792",
  "status": 400,
  "error": "Bad Request",
  "message": "Недостаточно средств на кошельке",
  "path": "uri=/api/v1/wallet"
}
```

---

## Тестирование:
   - В этом разделе описано, как запустить тесты для API:

### Шаги для запуска:

1. **Перейдите в папку с проектом:**
   ```
   cd SkillsRockTask
2. **Запустите команду:**
   ```
   ./gradlew test
3. **Приложение будет доступно по адресу:**
   Приложение запустит тесты, которые покрывают весь функционал методов.

   - Код приложения полностью покрыт юнит-тестами, а также покрыт интеграционными тестами для проверки взаимодействия разных частей приложения.

---

## Конкурентность

   - В этом разделе описывается, как сервис обрабатывает запросы в условиях высокой нагрузки и конкурентного доступа.


### Конкурентная обработка запросов

  - Использование блокировки на уровне базы данных: Чтобы гарантировать атомарность операций, используется пессимистичная блокировка строк в базе данных на уровне транзакций. В частности, используется @Transactional для чтения и записи баланса, что гарантирует корректную обработку запросов в многозадачной среде.
  - Поддержка 1000 RPS: Сервис настроен для работы с нагрузкой до 1000 запросов в секунду на один кошелек. Было использовано:
        - Блокировки на уровне базы данных с использованием транзакций и пессимистичной блокировки.

  - Тестирование с нагрузкой: Для тестирования высокой нагрузки можно использовать инструмент JMeter, чтобы имитировать множество параллельных запросов и оценить производительность.
